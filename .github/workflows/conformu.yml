name: ConformU

permissions:
  contents: read

on:
  push:
    branches: [main]
  pull_request:

jobs:
  conformu:
    name: ConformU Tests
    runs-on: ${{ matrix.os }}
    concurrency:
      group: ${{ github.workflow }}-${{ matrix.os }}-${{ github.head_ref || github.run_id }}
      cancel-in-progress: true
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install ConformU
        id: conformu
        uses: ivonnyssen/conformu-install@v1

      - name: Find ALPACA services
        id: find-alpaca
        shell: bash
        run: |
          # Find all packages that depend on ascom-alpaca
          ALPACA_PACKAGES=$(cargo metadata --format-version 1 --no-deps 2>/dev/null | \
            jq -r '.packages[] | select(.dependencies[]? | .name == "ascom-alpaca") | "-p " + .name' | \
            tr '\n' ' ' | xargs)
          echo "packages=$ALPACA_PACKAGES" >> $GITHUB_OUTPUT
          echo "Found ALPACA services: $ALPACA_PACKAGES"

      - name: Build ALPACA services
        shell: bash
        run: cargo build ${{ steps.find-alpaca.outputs.packages }} --release

      - name: Run ConformU tests - filemonitor
        timeout-minutes: 10
        run: cargo test -p filemonitor --test conformu_integration -- --ignored

      - name: Run ConformU tests - ppba-switch
        timeout-minutes: 10
        run: cargo test -p ppba-switch --features mock --test conformu_integration -- --ignored
