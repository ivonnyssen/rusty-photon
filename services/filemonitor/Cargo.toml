[package]
name = "filemonitor"
version.workspace = true
edition.workspace = true
authors.workspace = true
license.workspace = true
repository.workspace = true
rust-version = "1.88.0"
description = "File monitoring service for Rusty Photon"

[dependencies]
ascom-alpaca = { version = "1.0.0-beta.10", features = ["server", "safety_monitor", "test"] }
tokio = { workspace = true }
serde = { workspace = true }
serde_json = { workspace = true }
clap = { workspace = true }
regex = { workspace = true }
async-trait = { workspace = true }
tracing = { workspace = true }
tracing-subscriber = { workspace = true }

[package.metadata.conformu]
command = "cargo test -p filemonitor --test conformu_integration -- --ignored --nocapture"

[package.metadata.miri]
command = "cargo miri test -p filemonitor"

[package.metadata.deb]
maintainer = "Igor von Nyssen <igor@vonnyssen.com>"
extended-description = "ASCOM Alpaca SafetyMonitor that monitors file content for astrophotography safety."
section = "science"
priority = "optional"
assets = [
    ["target/release/filemonitor", "usr/bin/", "755"],
    ["pkg/config.json", "etc/filemonitor/config.json", "644"],
]
conf-files = ["/etc/filemonitor/config.json"]
maintainer-scripts = "pkg/"

[package.metadata.deb.systemd-units]
unit-name = "filemonitor"
unit-scripts = "pkg/"
enable = true
start = true
restart-after-upgrade = true

[package.metadata.generate-rpm]
summary = "ASCOM Alpaca SafetyMonitor that monitors file content"
license = "MIT OR Apache-2.0"
assets = [
    { source = "target/release/filemonitor", dest = "/usr/bin/filemonitor", mode = "755" },
    { source = "pkg/config.json", dest = "/etc/filemonitor/config.json", mode = "644", config = "noreplace" },
    { source = "pkg/filemonitor.service", dest = "/usr/lib/systemd/system/filemonitor.service", mode = "644" },
]
post_install_script = """
getent passwd filemonitor > /dev/null || useradd -r -s /sbin/nologin filemonitor
systemctl daemon-reload
systemctl enable filemonitor.service
"""
pre_uninstall_script = """
systemctl stop filemonitor.service || true
systemctl disable filemonitor.service || true
"""
post_uninstall_script = "systemctl daemon-reload"
require-sh = true

[dev-dependencies]
tokio-test = { workspace = true }
proptest = { workspace = true }
reqwest = { workspace = true }
tracing-subscriber = { workspace = true }
cucumber = { workspace = true }
tempfile = { workspace = true }

[[test]]
name = "bdd"
harness = false
